# ADR-002: D1 テナント分割戦略（初期は 1 org = 1 D1）

| 項目 | 内容 |
|------|------|
| ステータス | Accepted |
| 決定日 | 2026-02-20 |
| 対象 | 監査ログのデータ保存構成（D1/R2/Queue/DO） |
| 関連 | [PRODUCT.md](../../PRODUCT.md), [api_architecture_draft.md](../api_architecture_draft.md), [api_architecture_three_layers_draft.md](../api_architecture_three_layers_draft.md) |

---

## 1. 背景

- rekishi は監査ログ基盤として、以下を同時に満たす必要がある。
  - 改ざん耐性（原本を不変で保持）
  - マルチテナント分離
  - 一覧・検索の低レイテンシ
  - 将来スケールへの移行容易性
- 保存レイヤは以下の二層を前提とする。
  - `R2`: 原本（Source of Truth）
  - `D1`: ホット検索用の投影（rebuild 可能）
- 現時点の想定規模は **数百〜1,000 org**。

---

## 2. 決定

### 決定 A: 初期フェーズは `1 org = 1 D1` を採用する

- 各 org は専用 D1 DB を持つ。
- D1 には一覧・検索に必要な最小列のみを保存し、payload 全文は保存しない。
- 原本は常に R2 に保存し、D1 は再投影可能なインデックスとして扱う。

### 決定 B: ルーティング情報は META D1 で一元管理する

- `tenant_id -> d1_database_id` の対応を META D1 で管理する。
- 代表カラム:
  - `tenant_id`
  - `d1_database_id`
  - `status` (`provisioning` / `active` / `failed` / `migrating`)
  - `projection_version`
  - `created_at` / `updated_at`

### 決定 C: org 作成は非同期プロビジョニングとする

- イベント受信時に org が未登録でも受理する。
- org 未存在時は `provisioning` で登録し、以下を非同期実行する。
  1. D1 DB 作成
  2. スキーマ適用（migration）
  3. `status=active` へ遷移
- `active` 前のイベントは R2 に保存し、後段で D1 へ再投影する。

### 決定 D: 競合制御は Durable Object を用いる

- org 作成・再試行は org 単位ロックで直列化する。
- 同時作成レース時も冪等に収束させる。

---

## 3. 採用理由

- テナント分離が明確で、ノイジーネイバー影響を最小化しやすい。
- 監査要件上、障害時の切り分け（特定 org 単位）が容易。
- 想定規模（数百〜1,000 org）では運用可能な複雑度で開始できる。
- 将来の再分割（shared shard 併用や hot tenant 分離）へ移行可能。

---

## 4. 運用ガードレール

### 4.1 書き込み順序と整合性

- 書き込みは `R2 -> Queue -> D1投影` を基本とする。
- D1 書き込み失敗時も原本は R2 に残るため、再投影で回復可能。

### 4.2 バージョニング

- R2 原本: `schema_version`
- D1 投影: `projection_version`
- 一覧項目追加時は「列追加 -> version更新 -> backfill -> 切替」を行う。

### 4.3 障害復旧

- Queue の再試行枠を超えた場合に備え、R2 走査による再投影ジョブを持つ。
- 再投影は冪等 Upsert で実装する。

### 4.4 セキュリティ

- org 自動作成は API キー認可を通過したリクエストのみ許可する。
- テナント境界判定は `tenant_id` を認証コンテキストで強制し、payload の自己申告値を鵜呑みにしない。

---

## 5. 採用しなかった案

### 案 1: 初期から shared D1（複数 org 同居）

- 長所: DB 数・運用対象を減らせる。
- 短所: ノイジーネイバー影響が強く、テナント分離要件の説明が難しい。
- 今回は監査要件の分離優先で不採用。

### 案 2: D1 REST API をデータプレーンに常用

- 長所: binding 管理なしで DB を動的選択できる。
- 短所: API レート制限やレイテンシ面でホットパスに不利。
- 制御系（作成・管理）用途に限定し、検索/一覧のデータプレーンには採用しない。

---

## 6. 再評価トリガー

以下のいずれかを満たした場合、本 ADR を改訂する。

- org 数が 1,000 を超え、中期的に 3,000 超が見込まれる
- Worker binding の運用上限に近づく
- D1 の `overloaded` が継続的に発生する
- p95 レイテンシ・失敗率が SLO を継続超過する
- org 単位 DB 運用（作成・migration・監視）の運用コストが許容を超える

改訂時の第一候補は、`shared shard + hot tenant dedicated` のハイブリッド化とする。

---

## 7. 影響

### ポジティブ

- テナント分離が明確で、監査説明責任を満たしやすい。
- 障害影響を org 単位で局所化できる。
- R2 SoT により D1 破損時の再構築が可能。

### ネガティブ

- DB 数の増加により運用作業（作成・migration・監視）が増える。
- 将来的に binding/配線戦略の再設計が必要になる可能性が高い。

